name: ServiceBee CI/CD

on:
  push:
    branches: [ "main", "render" ]
  pull_request:
    branches: [ "main", "render" ]

jobs:
  # ═══════════════════════════════════════════════════════════════
  # STAGE 1: Security Audit
  # ═══════════════════════════════════════════════════════════════
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Audit Backend
      run: npm audit --audit-level=critical --prefix backend || echo "⚠️ Backend vulnerabilities found"

    - name: Audit Frontend
      run: npm audit --audit-level=critical --prefix frontend || echo "⚠️ Frontend vulnerabilities found"

  # ═══════════════════════════════════════════════════════════════
  # STAGE 2: Backend Validation
  # ═══════════════════════════════════════════════════════════════
  backend-check:
    name: Backend Check
    needs: security-audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'

    - name: Install Backend Dependencies
      run: npm ci --prefix backend

    - name: Lint Backend
      run: npm run lint --prefix backend

    - name: Validate Entry Point
      run: node --check backend/index.js

  # ═══════════════════════════════════════════════════════════════
  # STAGE 3: Frontend Validation & Build
  # ═══════════════════════════════════════════════════════════════
  frontend-check:
    name: Frontend Check
    needs: security-audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'

    - name: Install Frontend Dependencies
      run: npm ci --prefix frontend

    - name: Lint Frontend
      run: npm run lint --prefix frontend

    - name: Build Frontend
      run: npm run build --prefix frontend